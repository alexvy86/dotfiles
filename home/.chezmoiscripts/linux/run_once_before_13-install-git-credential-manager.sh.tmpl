# chezmoi:template:left-delimiter="# {{" right-delimiter=}}
# {{- /*
# See https://www.chezmoi.io/user-guide/frequently-asked-questions/troubleshooting/#chezmoi-reports-forkexec-no-such-file-or-directory-when-running-scripts-on-termux
# for details on the line below. Needed for this script to run successfully in Github Codespaces.
# */ -}}
#!# {{- lookPath "bash" }}

# Install Git Credential Manager
# https://github.com/git-ecosystem/git-credential-manager

# Check if git-credential-manager is already installed
if command -v git-credential-manager >/dev/null 2>&1; then
  echo "Git Credential Manager is already installed"
  exit 0
fi

echo "Installing Git Credential Manager..."

# {{- if .is_apt_distro }}

# Install Git Credential Manager using Debian package (official method)
# Detect system architecture
ARCH=$(uname -m)
case "${ARCH}" in
  x86_64)
    GCM_ARCH="amd64"
    ;;
  aarch64|arm64)
    GCM_ARCH="arm64"
    ;;
  armv7l)
    GCM_ARCH="armhf"
    ;;
  *)
    echo "Error: Unsupported architecture: ${ARCH}" >&2
    exit 1
    ;;
esac

# Get the latest release version from GitHub API
echo "Fetching latest Git Credential Manager version..."
# Try to use jq for robust JSON parsing, fall back to grep/sed if not available
if command -v jq >/dev/null 2>&1; then
  GCM_VERSION=$(curl -fsSL https://api.github.com/repos/git-ecosystem/git-credential-manager/releases/latest | jq -r '.tag_name // "" | ltrimstr("v")' || true)
else
  GCM_VERSION=$(curl -fsSL https://api.github.com/repos/git-ecosystem/git-credential-manager/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/' || true)
fi

if [[ -z "${GCM_VERSION}" ]]; then
  echo "Warning: Failed to fetch latest version, using fallback version 2.6.0" >&2
  GCM_VERSION="2.6.0"
fi

echo "Installing Git Credential Manager v${GCM_VERSION} for ${GCM_ARCH}..."
GCM_URL="https://github.com/git-ecosystem/git-credential-manager/releases/download/v${GCM_VERSION}/gcm-linux_${GCM_ARCH}.${GCM_VERSION}.deb"

# Create a temporary directory for the download
TMP_DIR=$(mktemp -d)
cd "${TMP_DIR}" || exit 1

# Download the Debian package
echo "Downloading Git Credential Manager v${GCM_VERSION}..."
if ! curl -fsSL -o gcm.deb "${GCM_URL}"; then
  echo "Error: Failed to download Git Credential Manager" >&2
  rm -rf "${TMP_DIR}"
  exit 1
fi

# Install the Debian package
echo "Installing Debian package..."
if ! sudo dpkg -i gcm.deb; then
  echo "Installing dependencies..."
  sudo apt-get install -f --yes
fi

# Clean up
cd - >/dev/null || exit 1
rm -rf "${TMP_DIR}"

# {{- else }}

# Install Git Credential Manager using Homebrew
echo "Installing Git Credential Manager via Homebrew..."
# Note: need to provide the absolute path to 'brew' because profile files are not read by chezmoi when starting shells
# to execute scripts, so it won't be in the PATH.
if ! /home/linuxbrew/.linuxbrew/bin/brew install git-credential-manager; then
  echo "Error: Failed to install Git Credential Manager via Homebrew" >&2
  exit 1
fi

# {{- end }}

# Configure Git Credential Manager
echo "Configuring Git Credential Manager..."
if ! git-credential-manager configure; then
  echo "Warning: Git Credential Manager installed but configuration failed" >&2
  echo "You may need to run 'git-credential-manager configure' manually" >&2
  exit 1
fi

echo "Git Credential Manager installed successfully"
