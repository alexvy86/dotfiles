# chezmoi:template:left-delimiter="# {{" right-delimiter=}}
# {{- /*
# See https://www.chezmoi.io/user-guide/frequently-asked-questions/troubleshooting/#chezmoi-reports-forkexec-no-such-file-or-directory-when-running-scripts-on-termux
# for details on the line below. Needed for this script to run successfully in Github Codespaces.
# */ -}}
#!# {{- lookPath "bash" }}

# Install Git Credential Manager
# https://github.com/git-ecosystem/git-credential-manager

# Check if git-credential-manager is already installed
if command -v git-credential-manager >/dev/null 2>&1; then
  echo "Git Credential Manager is already installed"
  exit 0
fi

echo "Installing Git Credential Manager..."

# Detect system architecture
ARCH=$(uname -m)
case "${ARCH}" in
  x86_64)
    GCM_ARCH="amd64"
    ;;
  aarch64|arm64)
    GCM_ARCH="arm64"
    ;;
  armv7l)
    GCM_ARCH="armhf"
    ;;
  *)
    echo "Error: Unsupported architecture: ${ARCH}" >&2
    exit 1
    ;;
esac

# Get the latest release version from GitHub API
echo "Fetching latest Git Credential Manager version..."
GCM_VERSION=$(curl -fsSL https://api.github.com/repos/git-ecosystem/git-credential-manager/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/' || true)

if [[ -z "${GCM_VERSION}" ]]; then
  echo "Error: Failed to fetch latest version, using fallback version 2.6.0" >&2
  GCM_VERSION="2.6.0"
fi

echo "Installing Git Credential Manager v${GCM_VERSION} for ${GCM_ARCH}..."
GCM_URL="https://github.com/git-ecosystem/git-credential-manager/releases/download/v${GCM_VERSION}/gcm-linux_${GCM_ARCH}.${GCM_VERSION}.tar.gz"

# Create a temporary directory for the download
TMP_DIR=$(mktemp -d)
cd "${TMP_DIR}" || exit 1

# Download the tarball
echo "Downloading Git Credential Manager v${GCM_VERSION}..."
if ! curl -fsSL -o gcm.tar.gz "${GCM_URL}"; then
  echo "Error: Failed to download Git Credential Manager" >&2
  rm -rf "${TMP_DIR}"
  exit 1
fi

# Extract to /usr/local/bin (requires sudo)
echo "Extracting to /usr/local/bin..."
if ! sudo tar -xzf gcm.tar.gz -C /usr/local/bin; then
  echo "Error: Failed to extract Git Credential Manager" >&2
  rm -rf "${TMP_DIR}"
  exit 1
fi

# Clean up
cd - >/dev/null || exit 1
rm -rf "${TMP_DIR}"

# Configure Git Credential Manager
echo "Configuring Git Credential Manager..."
git-credential-manager configure

echo "Git Credential Manager installed successfully"
