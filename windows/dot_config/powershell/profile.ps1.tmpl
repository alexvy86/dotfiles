# This is intended to be sourced by the "Current user, all hosts" PowerShell profile file
# (at $profile.CurrentUserAllHosts) so it applies to all host applications that host PowerShell
# (e.g. PowerShell ISE, VSCode).
#
# Done this way instead of directly creating the profile file with chezmoi because I have setups
# where the actual file lives in another drive and I can't update it easily with chezmoi.

{{ includeTemplate "../.chezmoitemplates/profile.ps1" . -}}

#----------------------------------------------------------
# Aliases
#----------------------------------------------------------

# NOTE: seems like the default version of OpenSSH that comes with Windows 11 has issues communicating with the ssh-agent
# to auto-add keys. The one in development in Github (https://github.com/powershell/Win32-OpenSSH) would probably work
# but I don't want to get into the trouble of overriding the default and configuring the new one.
# For now I'll live with dealing with authenticating the keys on every execution of SSH.
#
# Alias for SSH to auto-load ssh keys on first use and keep them in the agent for 10 hrs.
# function private:ssh {param($params);
# 	(ssh-add -l | Out-Null || (ssh-add -t 10h && Write-Host -ForegroundColor Green "ssh-key(s) are now available in ssh-agent for 10 hrs!`n")) && ssh $params;
# }

# Chezmoi commmands
function private:cuaf {
	chezmoi update --apply=false;
}

# Winget commands
function private:wlua {
	winget list --upgrade-available;
}

function private:install-apps {
	param(
		[switch]$personal
	)

	$StepName = "Installing packages from source 'winget'";
	Write-Host -ForegroundColor Cyan $StepName;

	$PathToGitInstallerSettings = Join-Path -Path $env:USERPROFILE -ChildPath ".config/git-for-windows-installer-settings.ini";
	$PathToVsCodeInstallerSettings = Join-Path -Path $env:USERPROFILE -ChildPath ".config/vscode-installer-settings.ini";

	$ApplicationsToInstall = @(
		@{Id = "Microsoft.WindowsTerminal"; },
		@{Id = "7zip.7zip"; },
		@{Id = "Git.Git"; Args = "/SILENT /LOADINF=$PathToGitInstallerSettings" },
		@{Id = "GitHub.GitLFS"; },
		@{Id = "JanDeDobbeleer.OhMyPosh"; },
		@{Id = "Microsoft.VisualStudioCode"; Args = "/SILENT /LOADINF=$PathToVsCodeInstallerSettings" },
		@{Id = "Microsoft.Edge.Dev"; },
		# Google.Chrome.EXE (vs Google.Chrome) does a user-level install
		@{Id = "Google.Chrome.EXE"; },
		@{Id = "AgileBits.1Password"; }
		# @{Id="Docker.DockerDesktop",
		# @{Id="Spotify.Spotify",
	);

	if ($personal) {
		$ApplicationsToInstall += @(
			@{Id = "Discord.Discord" },
			@{Id = "PrivateInternetAccess.PrivateInternetAccess" },
			@{Id = "Windscribe.Windscribe" },
			@{Id = "tailscale.tailscale" },
			@{Id = "Valve.Steam" }
		);
	}

	foreach ($app in $ApplicationsToInstall) {
		winget list --exact --id $app.Id --source winget > $null;
		if ($LastExitCode -eq 0) {
			Write-Host "Winget package $($app.Id) is already installed";
		} else {
			Write-Host "Installing Winget package $($app.Id)";
			if ($null -eq $app.Args) {
				winget install --exact --id $app.Id --source winget;
			} else {
				winget install --exact --id $app.Id --source winget --override "$($app.Args)";
			}
		}
	}

	# TODO: figure out why this didn't work (in Windows 11)
	# DevToys and WhatsApp always complained of "Verifying/Requesting package acquisition failed: server error"

	$StepName = "Installing applications from source 'msstore'";
	Write-Host -ForegroundColor Cyan $StepName;

	$MSStoreApplications = @(
		@{Id="9NBLGGH4NNS1"; Name="App Installer"},
		@{Id="9P7KNL5RWT25"; Name="Sysinternals Suite"}
		# @{Id="9PGCV4V3BK4W"; Name="Dev Toys"},
		);

	if ($personal) {
		$MSStoreApplications += @(
			# @{Id="9NKSQGP7F2NH"; Name="WhatsApp"}
		);
	}

	foreach ($app in $MSStoreApplications) {
		winget list --exact --id $app.Id --source msstore > $null;
		if ($LastExitCode -eq 0) {
			Write-Host "Package $($app.Name) ($($app.Id)) is already installed";
		} else {
			Write-Host "Installing MSStore app $($app.Name) ($($app.Id))";
			winget install --exact --id $app.Id --source msstore --accept-package-agreements --accept-source-agreements;
		}
	}
}
